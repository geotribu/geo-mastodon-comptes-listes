name: "ðŸ’¾ Export Geotribu Mastodon accounts and lists"

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    - cron: "0 5 * * SUN"  # weekly on sundays
  workflow_dispatch:     # to trigger manually

env:
  LANG: "fr_FR.UTF-8"
  LC_ALL: "fr_FR.UTF-8"
  LC_TIME: "fr_FR.UTF-8"

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write

  
jobs:

  run:
    name: Export des donnÃ©es du compte Geotribu sur Github Pages
    runs-on: ubuntu-latest

    steps:

      - name: Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: 3.12

      - name: Install dependencies
        # TODO: extra for mastodon only
        run: python -m pip install geotribu[all]

      - name: Export geotribu's mastodon lists and accounts
        env:
          GEOTRIBU_MASTODON_API_ACCESS_TOKEN: ${{ secrets.GEOTRIBU_MASTODON_API_ACCESS_TOKEN }}
        run: |
          mkdir mastodon
          geotribu social mastodon-export -w mastodon/export-mastodon

      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
  
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        with:
          path: mastodon/export-mastodon/
  
      - name: Deploy to GitHub Pages
        id: deployment
        if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
        uses: actions/deploy-pages@v4
  